global
        log /dev/log    local0
        log /dev/log    local1 notice
        stats timeout 30s
        user haproxy
        group haproxy
        daemon

defaults
        log     global
        timeout connect 5s  
        timeout client  50s  
        timeout server  50s  

listen stats
        bind *:81
        mode http
        stats enable
        stats refresh 30s
        stats uri /stats
        stats hide-version
        stats auth admin:admin

listen kubernetes-apiserver
        bind *:6443
        mode tcp
        option log-health-checks
        timeout client 300s
        timeout server 300s
        balance roundrobin
        server k8s-master-01 192.168.50.11:6443 check-ssl verify none
        server k8s-master-02 192.168.50.12:6443 check-ssl verify none
        server k8s-master-03 192.168.50.13:6443 check-ssl verify none

# listen argo-cd-server
#         bind *:32121
#         mode tcp
#         option log-health-checks
#         timeout client 300s
#         timeout server 300s
#         balance roundrobin
#         server k8s-master-01 192.168.50.11:32121 check-ssl verify none
#         server k8s-master-02 192.168.50.12:32121 check-ssl verify none
#         server k8s-master-03 192.168.50.13:32121 check-ssl verify none

frontend  main
        bind *:80
        maxconn 10000
        capture request  header Host len 200
        acl valid_http_method method GET POST PUT PATCH HEAD

        acl argocd_url_interna hdr_beg(host) -i argo.predator
        acl argocd_infra_path path_beg -i /
        use_backend backend_argocd if argocd_url_interna argocd_infra_path

backend backend_argocd
        mode http
        option log-health-checks
        default-server inter 10s downinter 5s rise 2 fall 2 slowstart 60s maxconn 2500 maxqueue 250 weight 100 on-marked-down shutdown-sessions
        balance roundrobin
        server k8s-master-01 192.168.50.11:32121 check
        server k8s-master-02 192.168.50.12:32121 check
        server k8s-master-03 192.168.50.13:32121 check
